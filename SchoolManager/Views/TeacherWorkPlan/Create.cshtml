@{
    ViewData["Title"] = "Crear Plan de Trabajo Trimestral";
    Layout = "_AdminLayout";
    var options = ViewBag.Options as SchoolManager.Dtos.TeacherWorkPlanFormOptionsDto ?? new SchoolManager.Dtos.TeacherWorkPlanFormOptionsDto();
}

<div class="container-fluid">
    <div class="mb-4" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 1.5rem 2rem; border-radius: 1rem;">
        <a href="@Url.Action("Index")" class="text-white text-decoration-none small"><i class="fas fa-arrow-left me-1"></i> Volver al listado</a>
        <h3 class="mb-0 mt-2"><i class="fas fa-plus-circle me-2"></i>Crear Plan de Trabajo Trimestral</h3>
        <small class="opacity-90">Complete la información y los bloques de contenido</small>
    </div>

    <form id="planForm">
        @Html.AntiForgeryToken()

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información general</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Año lectivo</label>
                        <select id="AcademicYearId" name="AcademicYearId" class="form-select" required>
                            <option value="">Seleccione...</option>
                            @foreach (var ay in options.AcademicYears)
                            {
                                <option value="@ay.Id">@ay.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Trimestre</label>
                        <select id="Trimester" name="Trimester" class="form-select" required>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Materia / Grado / Grupo</label>
                        <select id="AssignmentOption" class="form-select" required>
                            <option value="">Seleccione...</option>
                            @foreach (var a in options.AssignmentOptions)
                            {
                                var val = $"{a.SubjectId}|{a.GradeLevelId}|{a.GroupId}";
                                <option value="@val">@a.Label</option>
                            }
                        </select>
                        <input type="hidden" id="SubjectId" name="SubjectId" />
                        <input type="hidden" id="GradeLevelId" name="GradeLevelId" />
                        <input type="hidden" id="GroupId" name="GroupId" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Objetivos de aprendizaje</label>
                        <textarea id="Objectives" name="Objectives" class="form-control" rows="4" placeholder="Describa los objetivos de aprendizaje del trimestre..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Contenidos por bloques (semanas)</h5>
                <button type="button" id="btnAddRow" class="btn btn-sm btn-light"><i class="fas fa-plus me-1"></i>Agregar bloque</button>
            </div>
            <div class="card-body overflow-auto">
                <table class="table table-bordered" id="detailsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width:90px">Semanas</th>
                            <th>Tema</th>
                            <th>Conceptual</th>
                            <th>Procedimental</th>
                            <th>Actitudinal</th>
                            <th>Competencias básicas</th>
                            <th>Indicadores de logro</th>
                            <th style="width:50px"></th>
                        </tr>
                    </thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body d-flex gap-2 flex-wrap">
                <button type="submit" id="btnSaveDraft" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Guardar borrador
                </button>
                <button type="button" id="btnSubmit" class="btn btn-info">
                    <i class="fas fa-paper-plane me-1"></i>Enviar a revisión
                </button>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="~/lib/sweetalert2/sweetalert2.min.js"></script>
    <script>
        (function() {
            var detailsBody = document.getElementById('detailsBody');
            var assignmentSelect = document.getElementById('AssignmentOption');
            var planForm = document.getElementById('planForm');

            function setAssignmentIds() {
                var v = assignmentSelect.value;
                if (!v) return;
                var parts = v.split('|');
                if (parts.length >= 3) {
                    document.getElementById('SubjectId').value = parts[0];
                    document.getElementById('GradeLevelId').value = parts[1];
                    document.getElementById('GroupId').value = parts[2];
                }
            }
            assignmentSelect.addEventListener('change', setAssignmentIds);

            function addRow(order) {
                var tr = document.createElement('tr');
                tr.innerHTML =
                    '<td><input type="text" class="form-control form-control-sm weeks" placeholder="1-4" maxlength="20" /></td>' +
                    '<td><input type="text" class="form-control form-control-sm topic" placeholder="Tema" /></td>' +
                    '<td><textarea class="form-control form-control-sm conceptual" rows="2" placeholder="Contenido conceptual"></textarea></td>' +
                    '<td><textarea class="form-control form-control-sm procedural" rows="2" placeholder="Contenido procedimental"></textarea></td>' +
                    '<td><textarea class="form-control form-control-sm attitudinal" rows="2" placeholder="Contenido actitudinal"></textarea></td>' +
                    '<td><textarea class="form-control form-control-sm competencies" rows="2" placeholder="Competencias básicas"></textarea></td>' +
                    '<td><textarea class="form-control form-control-sm indicators" rows="2" placeholder="Indicadores de logro"></textarea></td>' +
                    '<td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-row"><i class="fas fa-times"></i></button></td>';
                tr.querySelector('.btn-remove-row').addEventListener('click', function() { tr.remove(); });
                tr.dataset.order = order;
                detailsBody.appendChild(tr);
            }

            document.getElementById('btnAddRow').addEventListener('click', function() {
                var n = detailsBody.querySelectorAll('tr').length;
                addRow(n);
            });

            addRow(0);

            function collectDetails() {
                var rows = detailsBody.querySelectorAll('tr');
                var list = [];
                rows.forEach(function(tr, i) {
                    list.push({
                        weeksRange: tr.querySelector('.weeks').value.trim(),
                        topic: tr.querySelector('.topic').value.trim(),
                        conceptualContent: tr.querySelector('.conceptual').value.trim(),
                        proceduralContent: tr.querySelector('.procedural').value.trim(),
                        attitudinalContent: tr.querySelector('.attitudinal').value.trim(),
                        basicCompetencies: tr.querySelector('.competencies').value.trim(),
                        achievementIndicators: tr.querySelector('.indicators').value.trim(),
                        displayOrder: i
                    });
                });
                return list;
            }

            function getPayload(status) {
                setAssignmentIds();
                var subjectId = document.getElementById('SubjectId').value;
                var gradeLevelId = document.getElementById('GradeLevelId').value;
                var groupId = document.getElementById('GroupId').value;
                if (!subjectId || !gradeLevelId || !groupId) {
                    Swal.fire({ icon: 'warning', title: 'Faltan datos', text: 'Seleccione año, trimestre y materia/grado/grupo.' });
                    return null;
                }
                return {
                    subjectId: subjectId,
                    gradeLevelId: gradeLevelId,
                    groupId: groupId,
                    academicYearId: document.getElementById('AcademicYearId').value,
                    trimester: parseInt(document.getElementById('Trimester').value, 10),
                    objectives: document.getElementById('Objectives').value.trim() || null,
                    status: status,
                    details: collectDetails()
                };
            }

            planForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var payload = getPayload('Draft');
                if (!payload) return;
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                fetch('@Url.Action("Create")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify(payload)
                })
                .then(function(r) {
                    if (r.ok) return r.json();
                    return r.json().then(function(j) { throw new Error(j.message || 'Error al guardar'); });
                })
                .then(function(data) {
                    Swal.fire({ icon: 'success', title: 'Guardado', text: data.message || 'Plan guardado como borrador.' })
                        .then(function() { window.location.href = '@Url.Action("Index")'; });
                })
                .catch(function(err) {
                    Swal.fire({ icon: 'error', title: 'Error', text: err.message });
                });
            });

            document.getElementById('btnSubmit').addEventListener('click', function() {
                var payload = getPayload('Submitted');
                if (!payload) return;
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                fetch('@Url.Action("Create")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify(payload)
                })
                .then(function(r) {
                    if (r.ok) return r.json();
                    return r.json().then(function(j) { throw new Error(j.message || 'Error al enviar'); });
                })
                .then(function(data) {
                    Swal.fire({ icon: 'success', title: 'Enviado', text: 'Plan enviado a revisión.' })
                        .then(function() { window.location.href = '@Url.Action("Index")'; });
                })
                .catch(function(err) {
                    Swal.fire({ icon: 'error', title: 'Error', text: err.message });
                });
            });
        })();
    </script>
}
