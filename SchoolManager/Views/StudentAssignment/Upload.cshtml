@{
    ViewData["Title"] = "Carga masiva de asignaciones de estudiantes";
    Layout = "_AdminLayout";
}

<style>
    #excelTable tbody tr.error-row {
        background-color: #ffebee !important;
        border-left: 4px solid #f44336 !important;
    }
    #excelTable tbody tr.error-row td {
        color: #f44336 !important;
        font-weight: bold !important;
        background-color: #ffebee !important;
        border-color: #f44336 !important;
    }
</style>

<h3>Cargar y previsualizar archivo Excel</h3>

<div class="alert alert-info mb-3">
    <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
            <h5><i class="bi bi-info-circle me-2"></i>Formato del archivo Excel</h5>
            <p class="mb-2">El archivo Excel debe tener las siguientes columnas en este orden:</p>
            <ol class="mb-0">
                <li><strong>Estudiante (Email):</strong> Correo electrónico del estudiante</li>
                <li><strong>Nombre:</strong> Nombre del estudiante</li>
                <li><strong>Apellido:</strong> Apellido del estudiante</li>
                <li><strong>Documento ID:</strong> Número de documento de identidad</li>
                <li><strong>Fecha Nacimiento:</strong> Fecha de nacimiento (formato: DD/MM/YYYY o número de Excel)</li>
                <li><strong>Grado:</strong> Nombre del grado</li>
                <li><strong>Grupo:</strong> Nombre del grupo</li>
                <li><strong>Inclusión:</strong> Indica si el estudiante tiene alguna discapacidad (si, no, o dejar vacío)</li>
            </ol>
        </div>
        <div class="ms-3">
            <a href="@Url.Action("DownloadTemplate", "File", new { fileName = "asignaciones_estudiantes_grado_grupo.xlsx" })" 
               class="btn btn-success btn-sm" 
               download="asignaciones_estudiantes_grado_grupo.xlsx">
                <i class="bi bi-download me-1"></i>
                Descargar Formato
            </a>
        </div>
    </div>
</div>

<input type="file" id="excelFile" class="form-control mb-3" accept=".xlsx,.xls" />

<table id="excelTable" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Estudiante (Email)</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Documento ID</th>
            <th>Fecha Nacimiento</th>
            <th>Grado</th>
            <th>Grupo</th>
            <th>Inclusión</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="text-right mt-3">
    <button id="btnGuardarAsignaciones" class="btn btn-success">Guardar Asignaciones</button>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <div class="mt-2">Procesando asignaciones...</div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            let filasConErrores = new Set();

            function marcarFilaConError(row) {
                row.addClass('error-row');
            }

            $('#excelFile').on('change', function (e) {
                const file = e.target.files[0];
                if (!file) {
                    Swal.fire("Archivo requerido", "Por favor selecciona un archivo Excel (.xlsx o .xls).", "warning");
                    return;
                }

                // Limpiar el conjunto de filas con errores al cargar nuevo archivo
                filasConErrores.clear();

                const reader = new FileReader();

                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    // Validación de encabezados exactos
                    const headersEsperados = ["ESTUDIANTE (EMAIL)", "NOMBRE", "APELLIDO", "DOCUMENTO ID", "FECHA NACIMIENTO", "GRADO", "GRUPO", "INCLUSIÓN"];
                    const headersObtenidos = json[0]?.map(h => h?.toString().trim().toUpperCase());
                    const headersValidados = headersEsperados.every((expected, i) =>
                        headersObtenidos[i] === expected
                    );

                    if (!headersValidados) {
                        Swal.fire(
                            "Encabezados incorrectos",
                            `Las columnas deben estar en este orden exacto: ${headersEsperados.join(", ")}`,
                            "error"
                        );
                        return;
                    }

                    const tbody = $('#excelTable tbody');
                    tbody.empty();

                    let filasInvalidas = 0;
                    let erroresDetallados = [];

                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        const rowNumber = i + 1;
                        const camposFaltantes = [];
                        
                        // Validar cada campo
                        if (!row[0] || row[0].toString().trim() === "") camposFaltantes.push("Estudiante (Email)");
                        if (!row[1] || row[1].toString().trim() === "") camposFaltantes.push("Nombre");
                        if (!row[2] || row[2].toString().trim() === "") camposFaltantes.push("Apellido");
                        if (!row[3] || row[3].toString().trim() === "") camposFaltantes.push("Documento ID");
                        if (!row[4] || row[4].toString().trim() === "") camposFaltantes.push("Fecha Nacimiento");
                        if (!row[5] || row[5].toString().trim() === "") camposFaltantes.push("Grado");
                        if (!row[6] || row[6].toString().trim() === "") camposFaltantes.push("Grupo");
                        // Inclusión es opcional, no se valida

                        // Validar formato de fecha DD/MM/YYYY o número de Excel
                        if (row[4] && row[4].toString().trim() !== "") {
                            const fechaStr = row[4].toString().trim();
                            let fechaValida = false;
                            
                            // Verificar si es formato DD/MM/YYYY
                            const fechaRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                            const match = fechaStr.match(fechaRegex);
                            
                            if (match) {
                                const dia = parseInt(match[1]);
                                const mes = parseInt(match[2]);
                                const año = parseInt(match[3]);
                                
                                // Validar rangos
                                if (dia >= 1 && dia <= 31 && mes >= 1 && mes <= 12 && año >= 1900 && año <= new Date().getFullYear()) {
                                    fechaValida = true;
                                }
                            } else {
                                // Verificar si es un número de Excel (fecha serial)
                                const numeroFecha = parseFloat(fechaStr);
                                if (!isNaN(numeroFecha) && numeroFecha > 0) {
                                    // Convertir número de Excel a fecha
                                    // Excel cuenta días desde 1900-01-01, pero tiene un bug: considera 1900 como año bisiesto
                                    const fechaExcel = new Date(1900, 0, numeroFecha - 2);
                                    
                                    // Verificar si la fecha es válida y está en un rango razonable
                                    if (fechaExcel.getFullYear() >= 1900 && fechaExcel.getFullYear() <= new Date().getFullYear()) {
                                        fechaValida = true;
                                    }
                                }
                            }
                            
                            if (!fechaValida) {
                                camposFaltantes.push("Fecha Nacimiento (formato inválido)");
                            }
                        }

                        const isValid = camposFaltantes.length === 0;
                        if (!isValid) {
                            filasInvalidas++;
                            filasConErrores.add(rowNumber);
                            erroresDetallados.push(`Fila ${rowNumber}: Faltan los campos: ${camposFaltantes.join(", ")}`);
                        }

                        // Convertir fecha de Excel a formato legible si es necesario
                        let fechaDisplay = row[4] ?? "";
                        if (fechaDisplay && fechaDisplay.toString().trim() !== "") {
                            const fechaStr = fechaDisplay.toString().trim();
                            const fechaRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                            
                            // Si no es formato DD/MM/YYYY, intentar convertir desde número de Excel
                            if (!fechaStr.match(fechaRegex)) {
                                const numeroFecha = parseFloat(fechaStr);
                                if (!isNaN(numeroFecha) && numeroFecha > 0) {
                                    try {
                                        const fechaExcel = new Date(1900, 0, numeroFecha - 2);
                                        const dia = fechaExcel.getDate().toString().padStart(2, '0');
                                        const mes = (fechaExcel.getMonth() + 1).toString().padStart(2, '0');
                                        const año = fechaExcel.getFullYear();
                                        fechaDisplay = `${dia}/${mes}/${año}`;
                                    } catch (e) {
                                        // Si falla la conversión, mantener el valor original
                                        fechaDisplay = fechaStr;
                                    }
                                }
                            }
                        }

                        // Procesar campo Inclusión
                        let inclusionDisplay = row[7] ?? "";
                        if (inclusionDisplay && inclusionDisplay.toString().trim().toLowerCase() === "si") {
                            inclusionDisplay = '<span class="badge bg-success"><i class="fas fa-heart me-1"></i>Sí</span>';
                        } else if (inclusionDisplay && inclusionDisplay.toString().trim().toLowerCase() === "no") {
                            inclusionDisplay = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>No</span>';
                        } else {
                            inclusionDisplay = '<span class="badge bg-secondary"><i class="fas fa-minus me-1"></i>Sin definir</span>';
                        }

                        const rowHtml = `
                            <tr data-row="${rowNumber}" data-inclusion="${row[7] ?? ""}">
                                <td>${row[0] ?? ""}</td>
                                <td>${row[1] ?? ""}</td>
                                <td>${row[2] ?? ""}</td>
                                <td>${row[3] ?? ""}</td>
                                <td>${fechaDisplay}</td>
                                <td>${row[5] ?? ""}</td>
                                <td>${row[6] ?? ""}</td>
                                <td>${inclusionDisplay}</td>
                            </tr>
                        `;
                        const $row = $(rowHtml);
                        tbody.append($row);

                        if (!isValid) {
                            marcarFilaConError($row);
                        }
                    }

                    if (filasInvalidas > 0) {
                        Swal.fire({
                            title: "Advertencia",
                            html: `
                                <div class="text-danger mb-2">${filasInvalidas} fila(s) tienen datos incompletos:</div>
                                <div style="max-height: 200px; overflow-y: auto; text-align: left;">
                                    ${erroresDetallados.join("<br>")}
                                </div>
                            `,
                            icon: "warning"
                        });
                    }

                    if ($.fn.DataTable.isDataTable('#excelTable')) {
                        $('#excelTable').DataTable().destroy();
                    }

                    $('#excelTable').DataTable({
                        paging: false,
                        info: false,
                        language: {
                            search: "Buscar:",
                            lengthMenu: "Mostrar _MENU_ registros",
                            paginate: {
                                first: "Primero",
                                last: "Último",
                                next: "Siguiente",
                                previous: "Anterior"
                            },
                            zeroRecords: "No se encontraron resultados",
                            infoEmpty: "Sin registros disponibles",
                            infoFiltered: "(filtrado de _MAX_ registros)"
                        }
                    });
                };

                reader.readAsArrayBuffer(file);
            });

            $('#btnGuardarAsignaciones').on('click', function () {
                const asignaciones = [];
                const errores = [];
                let rowNumber = 1;
                
                // Arrays para validar duplicados
                const emails = [];
                const documentos = [];

                $('#excelTable tbody tr').each(function () {
                    rowNumber++;
                    const $row = $(this);
                    const estudiante = $row.find('td').eq(0).text().trim();
                    const nombre = $row.find('td').eq(1).text().trim();
                    const apellido = $row.find('td').eq(2).text().trim();
                    const documentoId = $row.find('td').eq(3).text().trim();
                    const fechaNacimiento = $row.find('td').eq(4).text().trim();
                    const grado = $row.find('td').eq(5).text().trim();
                    const grupo = $row.find('td').eq(6).text().trim();
                    // Obtener el valor original de Inclusión desde los datos del Excel
                    const inclusionValue = $row.data('inclusion') || '';

                    const camposFaltantes = [];
                    if (!estudiante) camposFaltantes.push("Estudiante (Email)");
                    if (!nombre) camposFaltantes.push("Nombre");
                    if (!apellido) camposFaltantes.push("Apellido");
                    if (!documentoId) camposFaltantes.push("Documento ID");
                    if (!fechaNacimiento) camposFaltantes.push("Fecha Nacimiento");
                    if (!grado) camposFaltantes.push("Grado");
                    if (!grupo) camposFaltantes.push("Grupo");
                    
                    // Validar formato de correo electrónico
                    if (estudiante && estudiante.trim() !== "") {
                        const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                        if (!emailRegex.test(estudiante)) {
                            camposFaltantes.push("Estudiante (Email con formato inválido)");
                        } else {
                            // Verificar correo duplicado
                            if (emails.includes(estudiante.toLowerCase())) {
                                camposFaltantes.push("Estudiante (Email duplicado)");
                            } else {
                                emails.push(estudiante.toLowerCase());
                            }
                        }
                    }
                    
                    // Validar documento ID duplicado
                    if (documentoId && documentoId.trim() !== "") {
                        if (documentos.includes(documentoId.trim())) {
                            camposFaltantes.push("Documento ID (duplicado)");
                        } else {
                            documentos.push(documentoId.trim());
                        }
                    }

                    // Validar formato de fecha DD/MM/YYYY o número de Excel
                    if (fechaNacimiento && fechaNacimiento.trim() !== "") {
                        const fechaStr = fechaNacimiento.trim();
                        let fechaValida = false;
                        
                        // Verificar si es formato DD/MM/YYYY
                        const fechaRegex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                        const match = fechaStr.match(fechaRegex);
                        
                        if (match) {
                            const dia = parseInt(match[1]);
                            const mes = parseInt(match[2]);
                            const año = parseInt(match[3]);
                            
                            // Validar rangos
                            if (dia >= 1 && dia <= 31 && mes >= 1 && mes <= 12 && año >= 1900 && año <= new Date().getFullYear()) {
                                fechaValida = true;
                            }
                        } else {
                            // Verificar si es un número de Excel (fecha serial)
                            const numeroFecha = parseFloat(fechaStr);
                            if (!isNaN(numeroFecha) && numeroFecha > 0) {
                                // Convertir número de Excel a fecha
                                const fechaExcel = new Date(1900, 0, numeroFecha - 2);
                                
                                // Verificar si la fecha es válida y está en un rango razonable
                                if (fechaExcel.getFullYear() >= 1900 && fechaExcel.getFullYear() <= new Date().getFullYear()) {
                                    fechaValida = true;
                                }
                            }
                        }
                        
                        if (!fechaValida) {
                            camposFaltantes.push("Fecha Nacimiento (formato inválido)");
                        }
                    }

                    if (camposFaltantes.length > 0) {
                        errores.push(`Fila ${rowNumber}: Faltan los campos: ${camposFaltantes.join(", ")}`);
                        filasConErrores.add(rowNumber);
                        marcarFilaConError($row);
                    } else {
                        asignaciones.push({ 
                            estudiante, 
                            nombre, 
                            apellido, 
                            documentoId, 
                            fechaNacimiento, 
                            grado, 
                            grupo,
                            inclusion: inclusionValue
                        });
                    }
                });

                if (errores.length > 0) {
                    Swal.fire({
                        title: "Error de validación",
                        html: `
                            <div class="text-danger mb-2">Por favor, complete los siguientes campos:</div>
                            <div style="max-height: 200px; overflow-y: auto; text-align: left;">
                                ${errores.join("<br>")}
                            </div>
                        `,
                        icon: "error"
                    });
                    return;
                }

                if (asignaciones.length === 0) {
                    Swal.fire("Sin datos válidos", "No hay filas completas para guardar.", "error");
                    return;
                }

                Swal.fire({
                    title: "¿Deseas guardar?",
                    text: `Se van a guardar ${asignaciones.length} asignaciones válidas.`,
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Sí, guardar",
                    cancelButtonText: "Cancelar"
                }).then(result => {
                    if (result.isConfirmed) {
                        // Mostrar overlay y deshabilitar botón
                        $('#loadingOverlay').show();
                        $('#btnGuardarAsignaciones').prop('disabled', true);

                        $.ajax({
                            url: '/StudentAssignment/SaveAssignments',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(asignaciones),
                            success: function (response) {
                                $('#loadingOverlay').hide();
                                $('#btnGuardarAsignaciones').prop('disabled', false);
                                
                                let resumen = `
                                    <b>Asignaciones insertadas:</b> ${response.insertadas}<br>
                                    <b>Estudiantes creados:</b> ${response.estudiantesCreados || 0}<br>
                                    <b>Duplicadas:</b> ${response.duplicadas}<br>
                                `;

                                if (response.errores && response.errores.length > 0) {
                                    resumen += `<b>Errores:</b><ul>`;
                                    response.errores.slice(0, 10).forEach(err => {
                                        resumen += `<li>${err}</li>`;
                                    });
                                    if (response.errores.length > 10) {
                                        resumen += `<li>...y ${response.errores.length - 10} más.</li>`;
                                    }
                                    resumen += `</ul>`;
                                }

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Resultado de la carga',
                                    html: resumen,
                                    width: '50%',
                                    confirmButtonText: 'Aceptar'
                                });
                            },
                            error: function () {
                                $('#loadingOverlay').hide();
                                $('#btnGuardarAsignaciones').prop('disabled', false);
                                Swal.fire("Error del servidor", "No se pudieron guardar las asignaciones. Intenta más tarde.", "error");
                            }
                        });
                    }
                });
            });
        });
    </script>
}
